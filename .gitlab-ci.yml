stages:
  - test
  - build

variables:
  GO_VERSION: "1.24"

# Run tests on merge requests and main branch pushes
test:
  stage: test
  image: golang:${GO_VERSION}
  script:
    - go mod download
    - go test ./... -v -race
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build binary to verify compilation succeeds
build:
  stage: build
  image: golang:${GO_VERSION}
  script:
    - go mod download
    - go build -o jernel .
  artifacts:
    paths:
      - jernel
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
